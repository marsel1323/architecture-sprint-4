# Выбор и настройка мониторинга в системе

## Мотивация

Внедрение мониторинга позволит:

- Своевременно обнаруживать и устранять проблемы в работе системы.
- Ускорить диагностику узких мест и перегрузок.
- Предотвращать сбои и снижение производительности.
- Улучшить пользовательский опыт за счёт быстрого реагирования на проблемы.
- Собирать данные для анализа и оптимизации использования ресурсов.
- Оценивать влияние обновлений и новых функций на стабильность системы.

## Выбор подхода к мониторингу

Для мониторинга систем компании "Александрит" будет использоваться комбинированный подход:

- **RED**: Для мониторинга API всех систем. Основное внимание уделяется запросам, успешности и времени обработки.
- **USE**: Для мониторинга ресурсов, таких как CPU, память и дисковое пространство, в основном для MES.
- **Четыре золотых сигнала**: Для анализа RabbitMQ, баз данных и других узких мест.

### Обоснование выбора подхода:

Комбинированный подход позволяет охватить все аспекты системы, от производительности API до состояния ресурсов, что делает мониторинг максимально эффективным.

## Отслеживаемые метрики

### API (Shop, CRM, MES):

1. **Количество запросов (RPS)**:
    - Показывает нагрузку на систему.
    - Ярлыки: сервис, конечная точка API, HTTP-метод.

2. **Время ответа (latency)**:
    - Указывает на задержки и производительность.
    - Ярлыки: сервис, конечная точка API.

3. **Код ответа HTTP (500, 200)**:
    - Помогает идентифицировать критические ошибки.
    - Ярлыки: сервис, конечная точка API.

4. **Использование CPU и памяти**:
    - Показывает состояние ресурсов.
    - Ярлыки: узел, сервис.

### RabbitMQ:

1. **Количество сообщений в Dead Letter Queue**:
    - Указывает на необработанные сообщения.
    - Ярлыки: имя очереди.

2. **Количество сообщений в обработке**:
    - Помогает выявить проблемы с потребителями.
    - Ярлыки: имя очереди.

### Базы данных (Postgres для Shop, CRM, MES):

1. **Количество подключений**:
    - Предотвращает исчерпание пула соединений.
    - Ярлыки: база данных, тип подключения.

2. **Размер базы данных**:
    - Отслеживает рост данных.
    - Ярлыки: база данных.

3. **Время ответа запросов (latency)**:
    - Помогает выявить задержки.
    - Ярлыки: база данных.

### Хранилище (S3):

1. **Размер данных**:
    - Помогает управлять объёмом хранилища.
    - Ярлыки: имя хранилища.

2. Количество операций чтения/записи:
   - Помогает отслеживать активность и выявлять аномалии.
   - Ярлыки: имя хранилища, тип операции (GET, PUT).
   
3. Время ответа операций:
   - Позволяет выявить задержки при доступе к хранилищу.
   - Ярлыки: имя хранилища, тип операции.

4. Ошибки доступа (4xx, 5xx):
   - Позволяет мониторить ошибки при обращении к хранилищу.
   - Ярлыки: имя хранилища, тип ошибки.

## План действий

1. Добавить инструментарий для сбора метрик в сервисы (Prometheus Client).
2. Настроить экспортеры метрик для баз данных и RabbitMQ.
3. Развернуть Prometheus и интегрировать с service discovery.
4. Развернуть Grafana для визуализации метрик.
5. Настроить дашборды для ключевых метрик.
6. Настроить алерты:
    - Уведомления при превышении пороговых значений.
    - Автоматические действия при критических ситуациях (запуск дополнительного инстанса, уведомление инженера).
7. Настроить мониторинг операций S3:
   - Количество операций чтения и записи.
   - Время ответа операций.
   - Ошибки доступа (4xx, 5xx).
8. Создать дашборды в Grafana для мониторинга активности и состояния S3-хранилища.
9. Настроить алерты на критичные метрики:
   - Высокое количество ошибок (4xx, 5xx).
   - Долгое время ответа операций.

## Показатели насыщенности и реакции

1. **CPU > 70%**: Добавление нового инстанса.
2. **Memory > 80%**: Увеличение объёма памяти или добавление инстанса.
3. **Latency > 500ms для API**: Уведомление инженера.
4. **RPS превышает порог**: Автоматическое масштабирование.
5. Объём S3 хранилища > 90%:
   - Уведомление инженера.
   - Автоматическое масштабирование или очистка старых данных.

